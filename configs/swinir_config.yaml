# SwinIR 파인튜닝(무조영 NC-CT -> CE-CT Delay 스타일+선명도) 기본 설정
# 데이터 통계가 필요 없는 범위에서만 고정값 사용

task: "nc2ce_delay_sr"
device: "cuda"              # 자동 선택 로직에서 사용
amp: true                   # mixed precision

# =======================
# 데이터로더(패치/스택)
# =======================
data:
  patch_size: 256           # 초기 256, 안정화 후 320/384로 증대 가능
  z_stack: 5                # 2.5D 입력(중앙 슬라이스 기준 앞뒤 2장)
  batch_size: 6             # 24GB 기준 예시, GPU에 맞춰 조정
  shuffle: true
  num_workers: 8
  hu_clamp: [-150, 250]     # 모델 입력 전 클램프
  normalize:                # HU -> [-1,1] 정규화
    mode: "minmax"
    min: -150
    max: 250
  roi_weighting:            # 간 마스크가 있을 때만 사용(없으면 무시)
    enable: true
    liver_weight: 2.0
    border_weight: 1.5

# =======================
# 모델
# =======================
model:
  name: "SwinIR"
  variant: "SwinIR-M"       # Medium
  scale: 1                  # 초기는 1x (도메인 보정 위주), 이후 stageC에서 2로 변경 가능
  in_chans: 5               # z_stack과 동일(2.5D), 단일 2D면 1로 변경
  img_size: 64              # 내부 윈도우 참조 크기(학습 패치와 별개)
  window_size: 8
  embed_dim: 180
  depths: [6, 6, 6, 6]
  num_heads: [6, 6, 6, 6]
  mlp_ratio: 2.0
  upsampler: "pixelshuffle" # decoder 쪽
  pretrained:
    path: "E:\\LD-CT SR\\Weights\\004_grayDN_DFWB_s128w8_SwinIR-M_noise25.pth"
    strict: false

# =======================
# 학습 스케줄
# =======================
train:
  optimizer: "adamw"
  lr: 2.0e-5
  betas: [0.9, 0.99]
  weight_decay: 1.0e-4
  scheduler:
    name: "cosine"
    warmup_iters: 2000
  total_iters: 100000
  grad_clip: 1.0
  ema:
    enable: true
    decay: 0.999

# =======================
# 파인튜닝 전략(동결/LoRA)
# =======================
finetune:
  freeze:
    upsampler: true      # 초기엔 decoder(업샘플러) 고정
    last_conv: true
  unfreeze_at_iter: 70000  # 안정화 후 점진 해제 시작
  adapters:
    lora:
      enable: true
      target_modules: ["rstb.*.attn", "rstb.*.mlp"]  # RSTB 블록에 삽입
      rank: 8
      alpha: 16
      dropout: 0.0

# =======================
# 손실
# =======================
loss:
  l1:
    weight: 1.0
  ssim:
    weight: 0.2
    window: 11
  grad:
    weight: 0.05
    type: "sobel"    # or "laplacian"
  hist_match:
    weight: 0.1
    roi: "liver"     # 마스크 있을 때만 적용, 없으면 자동 skip

# =======================
# 체크포인트/로그
# =======================
io:
  save_every: 5000
  val_every: 5000
  max_keep: 10
  ckpt_dir: "E:\\LD-CT SR\\Outputs\\ckpts"
  log_dir:  "E:\\LD-CT SR\\Outputs\\logs"
  recon_dir:"E:\\LD-CT SR\\Outputs\\recon"
  report_dir:"E:\\LD-CT SR\\Outputs\\reports"

# =======================
# 평가
# =======================
eval:
  metrics: ["psnr", "ssim", "mae_hu", "cnr_liver_lesion"]
  crop_border: 0
